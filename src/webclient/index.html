<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Craigslist Housing Visualizer</title>
	<!-- Date: 2011-10-29 -->
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Niels Joubert">
	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<link rel="stylesheet" type="text/css" href="css/site.css">

	<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.16.custom.css">
	
	<script type="text/javascript" src="d3/d3.js"></script>
	<script type="text/javascript" src="d3/d3.layout.min.js"></script>
  
	<script type="text/javascript" src="jquery/jquery-1.6.4.min.js"></script> 
	<script type="text/javascript" src="jquery/jquery-ui-1.8.16.custom.min.js"></script> 

  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  
  <script type="text/javascript" src="mapper.js"></script>
  
  <script type="text/javascript" src="get_price_dist.json"></script> 

	
	<script type="text/javascript">

function hide_loading_box() {
  $("#loading_message_box").hide();
}
function change_loading_box(msg) {
  $("#loading_message_box").show();
  $("#loading_message_text").html('<h4>'+msg+'</h4>');
}
function show_global_error(message) {
  hide_loading_box();
  $("#error_message_content").html("<h2>critical error</h2><h3>Please reload the page, and contact us!</h3><p>" + message + "</p>");
  $("#error_message_box").show();
}

//Here is our interface to the webserver data source.
//This only provides us with raw data, and we perform transforms
//on this after everything arrives
function RawData() {
  var dataptr = this //lame JS hack to keep a ptr around to the object

  this.price_list = STARTUP_PRICE_DIST;
  this.sqft_list = [];
  this.bedroomcount_list = [];
  this.posts_count = 0;
  this.posts = [];
  
  var call_when_done = null
  var arrived = 0;
  var totalExpectedArrival = 0;
  var markArrive = function() {
    arrived += 1;
    if (totalExpectedArrival == arrived) {
      call_when_done(dataptr);
    }
  }
  
  this.getAllData = function(options,on_done) {
    call_when_done = on_done
    totalExpectedArrival = 4

    if (options) {
      $.ajax("/data/get_price_dist.json",          { data: options, success: arrivePriceDist,        error: arriveError });
      $.ajax("/data/get_sqft_dist.json",           { data: options, success: arriveSqftDist,         error: arriveError });
      $.ajax("/data/get_bedroomcount_dist.json",   { data: options, success: arriveBedroomCountDist, error: arriveError });
      $.ajax("/data/get_location_dist.json",       { data: options, success: arriveLocationDist,     error: arriveError });            
    } else {
      $.ajax("/data/get_price_dist.json",          { success: arrivePriceDist,        error: arriveError });
      $.ajax("/data/get_sqft_dist.json",           { success: arriveSqftDist,         error: arriveError });
      $.ajax("/data/get_bedroomcount_dist.json",   { success: arriveBedroomCountDist, error: arriveError });
      $.ajax("/data/get_location_dist.json",       { success: arriveLocationDist,     error: arriveError });      
    }
    
  }
  
  var arriveError = function(jqXHR, textStatus, errorThrown) {
    show_global_error(textStatus);
  }
  var arrivePriceDist = function(data, textStatus, jqXHR) {
    dataptr.price_list = data
    markArrive();
  }
  var arriveSqftDist = function(data, textStatus, jqXHR) {
    dataptr.sqft_list = data
    markArrive();
  }
  var arriveBedroomCountDist = function(data, textStatus, jqXHR) {
    dataptr.bedroomcount_list = data
    markArrive();
  }
  var arriveLocationDist = function(data, textStatus, jqXHR) {
    if (data.count) {
      dataptr.posts_count = data.count
      dataptr.posts = [];
    } else {
      dataptr.posts = data
      dataptr.posts_count = data.length
    }
    markArrive();
  }

}

function Bounds() {
  var dataptr = this;
  
  this.pr = [0,0];
  this.br = [0,0];
  this.sf = [0,0];
  
  this.pr_sel = [0,0]
  this.br_sel = [0,0]
  this.sf_sel = [0,0]
  
  this.compute = function(raw_data) {
    dataptr.pr_sel = dataptr.pr = findBoundsInArray(raw_data.price_list)
    dataptr.sf_sel = dataptr.sf = findBoundsInArray(raw_data.sqft_list)
    dataptr.br_sel = dataptr.br = findBoundsInArray(raw_data.bedroomcount_list)
  }
  
  this.getQuery = function() {
    return {
      "pmin" : dataptr.pr_sel[0],
      "pmax" : dataptr.pr_sel[1],
      "brmin": dataptr.br_sel[0],
      "brmax": dataptr.br_sel[1],
      "sqmin": dataptr.sf_sel[0],
      "sqmax": dataptr.sf_sel[1]
    }
  }
  
  var findBoundsInArray = function(arr) {
    var mymax = 0, mymin = 0;
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] != null) {
        mymax = arr[i];
        mymin = arr[i];
        break;
      }
    }
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] != null) {
        if (arr[i] > mymax)
          mymax = arr[i];
        if (arr[i] < mymin)
          mymin = arr[i];
      }
    }
    return [mymin,mymax];
  }
    
}

var raw_data = new RawData();
var bounds;

var c_price = 0;
var c_price_histogram = 0;
var histogram_height = 140;
var histogram_width = 475;


function update_range_text() {
  var pr = $("#price_slider").slider( "values" );
  var br = $("#bedroomcount_slider").slider( "values" );
  var sf = $("#sqft_slider").slider( "values" )
  
  bounds.pr_sel = pr;
  bounds.br_sel = br;
  bounds.sf_sel = sf;
  
  $("#price_values").html("$"+pr[0]+" - $"+pr[1]);
  $("#bedroomcount_values").html(""+br[0]+" - "+br[1]);
  $("#sqft_values").html(""+sf[0]+"sqft - "+sf[1]+"sqft");
  $("#city_values").html(""+raw_data.posts_count+" posts");
}

function init_ui(raw_data,bounds) {
  
  $("#price_slider").slider({
    range: true,
    min: bounds.pr[0],
    max: bounds.pr[1],
    values: bounds.pr,
    slide: function(e,u) { update_range_text(); return true;},
    stop: function() {update_range_text(); reloadshit(false)}
  });
  
  $("#bedroomcount_slider").slider({
    range: true,
    min: bounds.br[0],
    max: bounds.br[1],
    values: bounds.br,
    slide: function(e,u) { update_range_text(); return true;},
    stop: function() {update_range_text(); reloadshit(false)}
  });
  
  $("#sqft_slider").slider({
    range: true,
    min: bounds.sf[0],
    max: bounds.sf[1],
    values: bounds.sf,
    slide: function(e,u) { update_range_text(); return true;},
    stop: function() {update_range_text(); reloadshit(false)}
  });
  
  update_range_text();
}




var p_x  = null
var p_y  = null
var bd_x = null
var bd_y = null
var sq_x = null
var sq_y = null

function update_histograms(raw_data,completely_new) {
  var w = histogram_width,
      h = histogram_height;
 
  var c_price_histogram = d3.layout.histogram()
    .range(bounds.pr)
    (raw_data.price_list);
  var c_bedroomcount_histogram = d3.layout.histogram()
    .range(bounds.br)
    .bins([1,2,3,4,5,6,7,8,9])
    (raw_data.bedroomcount_list);
  var c_sqft_histogram = d3.layout.histogram()
    .range(bounds.sf)
    (raw_data.sqft_list);
  
  if (completely_new) {
    p_x = d3.scale.ordinal()
        .domain(c_price_histogram.map(function(d) { return d.x; }))
        .rangeRoundBands([0, w]); 
    p_y = d3.scale.linear()
        .domain([0, d3.max(c_price_histogram, function(d) { return d.y; })])
        .range([0, h]);

    bd_x = d3.scale.ordinal()
        .domain(c_bedroomcount_histogram.map(function(d) { return d.x; }))
        .rangeRoundBands([0, w]); 
    bd_y = d3.scale.linear()
        .domain([0, d3.max(c_bedroomcount_histogram, function(d) { return d.y; })])
        .range([0, h]);

    sq_x = d3.scale.ordinal()
        .domain(c_sqft_histogram.map(function(d) { return d.x; }))
        .rangeRoundBands([0, w]); 
    sq_y = d3.scale.linear()
        .domain([0, d3.max(c_sqft_histogram, function(d) { return d.y; })])
        .range([0, h]);
  
    c_price.selectAll("rect").remove()
    c_price.selectAll("rect")
        .data(c_price_histogram)
      .enter().append("svg:rect")
        .attr("x", function(d) { return p_x(d.x); })
        .attr("y", 0)
        .attr("width", p_x.rangeBand())
        .attr("height", function(d) { return p_y(d.y); })

    c_bedroomcount.selectAll("rect").remove()
    c_bedroomcount.selectAll("rect")
        .data(c_bedroomcount_histogram)
      .enter().append("svg:rect")
        .attr("x", function(d) { return bd_x(d.x); })
        .attr("y", 0)
        .attr("width", bd_x.rangeBand())
        .attr("height", function(d) { return bd_y(d.y); })

    c_sqft.selectAll("rect").remove()
    c_sqft.selectAll("rect")
        .data(c_sqft_histogram)
      .enter().append("svg:rect")
        .attr("x", function(d) { return sq_x(d.x); })
        .attr("y", 0)
        .attr("width", sq_x.rangeBand())
        .attr("height", function(d) { return sq_y(d.y); })
  } 

    c_price.selectAll("rect")
        .data(c_price_histogram)
      .transition()
        .duration(750)
        .attr("y", 0)
        .attr("height", function(d) { return p_y(d.y); })

    c_bedroomcount.selectAll("rect")
        .data(c_bedroomcount_histogram)
      .transition()
        .duration(750)
        .attr("y", 0)
        .attr("height", function(d) { return bd_y(d.y); })

    c_sqft.selectAll("rect")
        .data(c_sqft_histogram)
      .transition()
        .duration(750)
        .attr("y", 0)
        .attr("height", function(d) { return sq_y(d.y); })


}

function update_map(raw_data) {
  if (raw_data.posts && raw_data.posts.length > 0) {
    
    mmp_clearPins();
    for (var i = 0; i < raw_data.posts.length; i++) {
      
      mmp_dropPin(
        raw_data.posts[i]["loc_xstreet0"] + " at " + raw_data.posts[i]["loc_xstreet1"], 
        raw_data.posts[i]["title"], 
        "<h3><a href='"+raw_data.posts[i]["link"]+"' target='_blank'>"+raw_data.posts[i]["title"]+"</a></h3>"
        );
    }
    
    
  }
}

function processData(raw_data,completely_new) {
  change_loading_box("Processing Data");
  
  if (completely_new) {
    bounds = new Bounds()
    bounds.compute(raw_data);
    init_ui(raw_data,bounds);
  }
  update_range_text();
  update_histograms(raw_data,completely_new);
  update_map(raw_data)
  hide_loading_box();
}
 
function reloadshit(completely_new) {
  raw_data = new RawData();
  change_loading_box("Loading...");
  
  var options = {}
  if (!completely_new) 
    options = bounds.getQuery();
  options["city"] = $("#city_select").val();
  mmp_initialize(CITY_T[$("#city_select").val()]); 
  
  //will call processData next;
  raw_data.getAllData(options,function(data) { processData(raw_data,completely_new); });
  
}

//jQuery document initialization entrypoint 
$(document).ready(function() {
      
  mmp_initialize(CITY_T[$("#city_select").val()]); 
      
  c_price = d3.select("#price_histogram")
    .append("svg:svg")
    .attr("class", "histogram_chart")
    .attr("width", histogram_width + "px")
    .attr("height", histogram_height + "px")
    .append("svg:g")
      .attr("transform", "translate(.5," + histogram_height + ") scale(1,-1)");
  

  c_bedroomcount = d3.select("#bedroomcount_histogram")
    .append("svg:svg")
    .attr("class", "histogram_chart")
    .attr("width", histogram_width + "px")
    .attr("height", histogram_height + "px")
    .append("svg:g")
      .attr("transform", "translate(.5," + histogram_height + ") scale(1,-1)");

  c_sqft = d3.select("#sqft_histogram")
    .append("svg:svg")
    .attr("class", "histogram_chart")
    .attr("width", histogram_width + "px")
    .attr("height", histogram_height + "px")
    .append("svg:g")
      .attr("transform", "translate(.5," + histogram_height + ") scale(1,-1)");

  
  raw_data.getAllData(null,function(data) {processData(data,true);});
  $("#city_select").change(function() {reloadshit(true);});
  
});  
  </script>
</head>
<body>
<div class="container">
  
  <div class="page_center_float" id="loading_message_box">
    <div class="middle_float" id="loading_message_content">
      <div id="loading_message_status">
        <img src="img/spinner3.gif" />
        <span id="loading_message_text">
        <h4>Loading Data</h4>
        </span>
      </div>
    </div>
  </div>
  <div class="page_center_float" id="error_message_box">
    <div class="middle_float" id="error_message_content">

    </div>
  </div>
  
  <div class="header">
    <div class="left_float">
      <h2>craigslist housing helper</h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This data is <em>live</em> from Craigslist.

    </div>
    <div class="right_float" id="attribution">
      <a href="https://graphics.stanford.edu/wikis/cs448b-11-fall">CS448B project</a>, <a href="njoubert.com">Niels Joubert</a> and <a href="http://cs.stanford.edu/people/eschkufz/">Eric Schkufza</a>
    </div>
  </div>
  
  <div class="content">
        
    <div id="databox">
      <div class="leftside">
        <div class="halfitem">
          <div class="item_heading"><h4>map</h4></div>
          <div id="map_canvas">
            Map loading...
          </div>
        </div>
      </div>
      <div class="rightside">
        <div class="halfitem">
          <div class="item_heading"><h4>city</h4> <span class="item_values" id="city_values"></span></div>
          <select id="city_select">
            <option value="sfc" selected>San Francisco</option>
            <option value="sby">South Bay</option>
            <option value="eby">Easy Bay</option>
            <option value="pen">Peninsula</option>
            <option value="nby">North Bay</option>
            <option value="scz">Santa Cruz</option>
          </select>
        </div>
        <div class="halfitem">
          <div class="item_heading"><h4>price</h4> <span class="item_values" id="price_values"></span></div>
          <div class="histogram" id="price_histogram"></div>
          <div class="slider"    id="price_slider"></div>
        </div>
        <div class="halfitem">
          <div class="item_heading"><h4>number of bedrooms</h4> <span class="item_values" id="bedroomcount_values"></div>
          <div class="histogram" id="bedroomcount_histogram"></div>
          <div class="slider"    id="bedroomcount_slider"></div>
        </div>
        <div class="halfitem">
          <div class="item_heading"><h4>square footage</h4> <span class="item_values" id="sqft_values"></div>
          <div class="histogram" id="sqft_histogram"></div>
          <div class="slider"    id="sqft_slider"></div>
        </div>
      </div>
    </div>
      <div id="blurbshit">
    
        <p>
        When searching for housing, we start by picking criteria, examples are price, location, bedrooms and square footage.
        We then examine the available house postings to find matches for these criteria. Once we've found a set of matches,
        we physically visit these places to gauge their viability. Usually at this point we discover that our criteria are not ideal, and we
        adjust them appropriately, restarting the process.
        </p>
        <p>
        Craigslist receives over 30,000 housing-related posts every week, and that's only in the Bay Area. This process of slowly varying your
        criteria until you find an appropriate place is far too slow to keep up with this torrent of information. 
        </p>
        </p>
        This project is aimed at helping the prospective renter or buyer at evaluating their criteria by looking at the distribution of
        posts for these criteria on craigslist.
        </p>
        
      </div>

  </div>

  
</div>
</body>
</html>
