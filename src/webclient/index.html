<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Craigslist Housing Visualizer</title>
	<!-- Date: 2011-10-29 -->
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Niels Joubert">
	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<link rel="stylesheet" type="text/css" href="css/site.css">

	<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.16.custom.css">
	
	<script type="text/javascript" src="jquery/jquery-1.6.4.min.js"></script> 
	<script type="text/javascript" src="jquery/jquery-ui-1.8.16.custom.min.js"></script> 
	
  <script type="text/javascript" src="d3-9520b07/d3.js"></script>
  <script type="text/javascript">

function hide_loading_box() {
  $("#loading_message_box").fadeOut('fast');
}
function change_loading_box(msg) {
  $("#loading_message_box").show();
  $("#loading_message_text").html('<h4>'+msg+'</h4>');
}
function show_global_error(message) {
  hide_loading_box();
  $("#error_message_content").html("<h2>critical error</h2><h3>Please reload the page, and contact us!</h3><p>" + message + "</p>");
  $("#error_message_box").show();
}

//Here is our interface to the webserver data source.
//This only provides us with raw data, and we perform transforms
//on this after everything arrives
function RawData() {
  var dataptr = this //lame JS hack to keep a ptr around to the object

  this.price_list = [];
  this.sqft_list = [];
  this.bedroomcount_list = [];
  this.posts_count = 0;
  
  var call_when_done = null
  var arrived = 0;
  var totalExpectedArrival = 0;
  var markArrive = function() {
    arrived += 1;
    if (totalExpectedArrival == arrived) {
      call_when_done(dataptr);
    }
  }
  
  this.getAllData = function(options,on_done) {
    call_when_done = on_done
    totalExpectedArrival = 4

    if (options) {
      $.ajax("/data/get_price_dist.json",          { data: options, success: arrivePriceDist,        error: arriveError });
      $.ajax("/data/get_sqft_dist.json",           { data: options, success: arriveSqftDist,         error: arriveError });
      $.ajax("/data/get_bedroomcount_dist.json",   { data: options, success: arriveBedroomCountDist, error: arriveError });
      $.ajax("/data/get_location_dist.json",       { data: options, success: arriveLocationDist,     error: arriveError });            
    } else {
      $.ajax("/data/get_price_dist.json",          { success: arrivePriceDist,        error: arriveError });
      $.ajax("/data/get_sqft_dist.json",           { success: arriveSqftDist,         error: arriveError });
      $.ajax("/data/get_bedroomcount_dist.json",   { success: arriveBedroomCountDist, error: arriveError });
      $.ajax("/data/get_location_dist.json",       { success: arriveLocationDist,     error: arriveError });      
    }
    
  }
  
  var arriveError = function(jqXHR, textStatus, errorThrown) {
    show_global_error(textStatus);
  }
  var arrivePriceDist = function(data, textStatus, jqXHR) {
    dataptr.price_list = data
    markArrive();
  }
  var arriveSqftDist = function(data, textStatus, jqXHR) {
    dataptr.sqft_list = data
    markArrive();
  }
  var arriveBedroomCountDist = function(data, textStatus, jqXHR) {
    dataptr.bedroomcount_list = data
    markArrive();
  }
  var arriveLocationDist = function(data, textStatus, jqXHR) {
    if (data.count) {
      dataptr.posts_count = data.count
    } else {
      dataptr.posts = data
    }
    markArrive();
  }

}

function Bounds() {
  var dataptr = this;
  
  this.pr = [0,0];
  this.br = [0,0];
  this.sf = [0,0];
  
  this.pr_sel = [0,0]
  this.br_sel = [0,0]
  this.sf_sel = [0,0]
  
  this.compute = function(raw_data) {
    dataptr.pr_sel = dataptr.pr = findBoundsInArray(raw_data.price_list)
    dataptr.sf_sel = dataptr.sf = findBoundsInArray(raw_data.sqft_list)
    dataptr.br_sel = dataptr.br = findBoundsInArray(raw_data.bedroomcount_list)
  }
  
  this.getQuery = function() {
    return {
      "pmin" : this.pr_sel[0],
      "pmax" : this.pr_sel[1],
      "brmin": this.br_sel[0],
      "brmax": this.br_sel[1],
      "sqmin": this.sf_sel[0],
      "sqmax": this.sf_sel[1]
    }
  }
  
  var findBoundsInArray = function(arr) {
    var mymax = 0, mymin = 0;
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] != null) {
        mymax = arr[i];
        mymin = arr[i];
        break;
      }
    }
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] != null) {
        if (arr[i] > mymax)
          mymax = arr[i];
        if (arr[i] < mymin)
          mymin = arr[i];
      }
    }
    return [mymin,mymax];
  }
    
}

var raw_data = new RawData();
var bounds = new Bounds();

function init_ui(raw_data,bounds) {
  
  $("#price_slider").slider({
    range: true,
    min: bounds.pr[0],
    max: bounds.pr[1],
    values: bounds.pr
  });
  
  $("#bedroomcount_slider").slider({
    range: true,
    min: bounds.br[0],
    max: bounds.br[1],
    values: bounds.br
  });
  
  $("#sqft_slider").slider({
    range: true,
    min: bounds.sf[0],
    max: bounds.sf[1],
    values: bounds.sf
  });
  
}

function processData(raw_data,first_time) {
  change_loading_box("Processing Data");
  
  if (first_time) {
    bounds.compute(raw_data);
    init_ui(raw_data,bounds);
  }
  
  $("#po_count").html("<h2>"+ bounds.pr +" price range in database, loaded </h2>")
  $("#sq_count").html("<h2>"+ bounds.sf         +" posts in database, loaded </h2>")
  $("#bd_count").html("<h2>"+ bounds.br +" posts in database, loaded </h2>")
  $("#pr_count").html("<h2>"+raw_data.posts_count              +" posts in database, loaded </h2>")
  
  
  hide_loading_box();
}

function reloadshit() {
  d = new RawData();
  change_loading_box("Loading...");
  d.getAllData(bounds.getQuery(),function(data) {processData(data,false);});
  
}

//jQuery document initialization entrypoint 
$(document).ready(function() {
  
  raw_data.getAllData(null,function(data) {processData(data,true);});
  
});  
  </script>
</head>
<body>
<div class="container">
  
  <div class="page_center_float" id="loading_message_box">
    <div class="middle_float" id="loading_message_content">
      <div id="loading_message_status">
        <img src="img/spinner3.gif" />
        <span id="loading_message_text">
        <h4>Loading Data</h4>
        </span>
      </div>
    </div>
  </div>
  <div class="page_center_float" id="error_message_box">
    <div class="middle_float" id="error_message_content">

    </div>
  </div>
  
  <div class="header">
    <div class="left_float">
      <h2>craigslist housing helper</h2>
    </div>
    <div class="right_float" id="attribution">
      <a href="https://graphics.stanford.edu/wikis/cs448b-11-fall">CS448B project</a>, <a href="njoubert.com">Niels Joubert</a> and <a href="http://cs.stanford.edu/people/eschkufz/">Eric Schkufza</a>
    </div>
  </div>
  
  <div class="content">
    
    <div id="databox">
      <div class="leftside">
        <div class="halfitem">MAP</div>
      </div>
      <div class="rightside">
        <div class="halfitem">
          <h2>city</h2>
          
        </div>
        <div class="halfitem">
          <h2>price</h2>
          <div id="price_slider"></div>
        </div>
        <div class="halfitem">
          <h2>number of bedrooms</h2>
          <div id="bedroomcount_slider"></div>
        </div>
        <div class="halfitem">
          <h2>square footage</h2>
          <div id="sqft_slider"></div>
          

        </div>

      </div>
    </div>
    
    
        <p>
        When searching for housing, we start by picking criteria, examples are price, location, bedrooms and square footage.
        We then examine the available house postings to find matches for these criteria. Once we've found a set of matches,
        we physically visit these places to gauge their viability. Usually at this point we discover that our criteria are not ideal, and we
        adjust them appropriately, restarting the process.
        </p>
        <p>
        Craigslist receives over 30,000 housing-related posts every week, and that's only in the Bay Area. This process of slowly varying your
        criteria until you find an appropriate place is far too slow to keep up with this torrent of information. 
        </p>
        </p>
        This project is aimed at helping the prospective renter or buyer at evaluating their criteria by looking at the distribution of
        posts for these criteria on craigslist.
        </p>
        
        <div id="po_count"><h2>no posts yet</h2></div>
        <div id="sq_count"><h2>no posts yet</h2></div>
        <div id="bd_count"><h2>no posts yet</h2></div>
        <div id="pr_count"><h2>no posts yet</h2></div>
        
        <a href="#" onClick="reloadshit(); return false;">HELLO</a>

  </div>

  
</div>
</body>
</html>
